stages:
  - test
  - build
  - staging
  - test_e2e
  - production

.build-docker: &build-docker
  tags:
    - build
  before_script:
    - mkdir -p ~/.docker
    - echo "$DOCKER_CREDENTIALS" > ~/.docker/config.json
  script:
    - export DOCKER_TAG="$CI_COMMIT_SHA"
    - docker-compose build
    - docker-compose push

.ssh-deploy: &runner-deploy
  tags:
    - deploy
  script:
    - export DOCKER_TAG="$CI_COMMIT_SHA"
    - docker-compose up -d --quiet-pull

Build staging docker:
  <<: *build-docker
  stage: build
  environment:
    name: staging
  only:
    - develop
  except:
    - merge_requests
  when: manual
  allow_failure: false

Build production docker:
  <<: *build-docker
  stage: build
  environment:
    name: production
  only:
    - master
  except:
    - merge_requests

Deploy to staging:
  <<: *runner-deploy
  dependencies:
    - Build staging docker
  stage: staging
  environment:
    name: staging
  only:
    - develop
  except:
    - merge_requests

Deploy to production:
  <<: *runner-deploy
  dependencies:
    - Build production docker
  stage: production
  environment:
    name: production
  only:
    - master
  except:
    - merge_requests
  when: manual

Unit tests:
  tags:
    - test
  image: node:14
  stage: test
  cache:
    paths:
      - ~/.yarn
      - node_modules
      - backend/main/node_modules
      - frontend/node_modules
      - frontend/web/node_modules
      - frontend/web/common/node_modules
      - frontend/web/app/node_modules
      - frontend/web/admin/node_modules
      - frontend/web/landing/node_modules
      - frontend/web/test/node_modules
      - frontend/web/storybook/node_modules
  before_script:
    - cd frontend
    - yarn --frozen-lockfile
    - cd ../backend/main
    - yarn --frozen-lockfile
    - cd ../..
  script:
    # add coverage to tests?
    - cd backend/main
    - yarn test
    - cd ../../frontend/common
    - yarn test
    - cd ../native/app
    - yarn test
    - cd ../../web/common
    - yarn test
    - cd ../app
    - yarn test
  only:
    - merge_requests

E2E tests:
  tags:
    - test
  image: node:14
  stage: test_e2e
  cache:
    paths:
      - ~/.yarn
      - node_modules
      - backend/main/node_modules
      - frontend/node_modules
      - frontend/web/node_modules
      - frontend/web/common/node_modules
      - frontend/web/app/node_modules
      - frontend/web/admin/node_modules
      - frontend/web/landing/node_modules
      - frontend/web/test/node_modules
      - frontend/web/storybook/node_modules
  before_script:
    - cd frontend/web/test
    - yarn --frozen-lockfile
    - cd ../../../backend
    - yarn --frozen-lockfile
    - cd ..
  script:
    - cd backend/main
    - yarn test:e2e
    - cd ../../frontend/web/test
    - yarn test
  only:
    - merge_requests && master
